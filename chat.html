<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ManoVeda — Chat</title>

  <!-- Use your external chat.css (keep your file as provided) -->
  <link rel="stylesheet" href="chat.css" />

  <!-- Fonts / icons already used in your project -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Markdown parser and sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <!-- Small additions to complement your chat.css for readable paragraphs & code -->
  <style>
    /* make sure rendered markdown inside bot bubbles looks good */
    .bot-message p { margin: 0 0 0.75rem; }
    .bot-message ul, .bot-message ol { margin: 0.4rem 0 0.8rem 1.1rem; }
    .bot-message code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; font-family: monospace; }
    .message time { display:block; font-size: 11px; opacity: 0.6; margin-top: 6px; }
    /* ensure chat box has comfortable bottom padding so last message not hidden under input */
    .chat-box { padding-bottom: 24px; }
    /* typing bubble small animation tweak */
    .bot-message.typing { opacity: 0.9; }
    .typing-dots span { display:inline-block; width:6px; height:6px; margin-left:4px; border-radius:50%; background:#fff; opacity:.25; animation: blink 1s infinite; }
    .typing-dots span:nth-child(2){ animation-delay: .15s }
    .typing-dots span:nth-child(3){ animation-delay: .30s }
    @keyframes blink { 0%{opacity:.2}50%{opacity:1}100%{opacity:.2} }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- optional luxury frame if you use it in markup -->
    <div class="luxury-frame" aria-hidden="true">
      <div class="lux-seg lux-top"></div>
      <div class="lux-seg lux-right"></div>
      <div class="lux-seg lux-bottom"></div>
      <div class="lux-seg lux-left"></div>
    </div>

    <!-- Top Navigation -->
    <nav id="navbar">
      <div class="glass">
        <div class="brand"><span class="mano">Mano</span><span class="veda">Veda AI</span></div>
        <a class="back" href="Index.html">← Dashboard</a>
      </div>
    </nav>

    <!-- Chat Messages -->
    <div class="chat-box" id="chatBox" role="log" aria-live="polite"></div>

    <!-- Input Area -->
    <div class="chat-input-area" role="form">
      <input type="text" id="userInput" placeholder="Type your thoughts here..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <script>
    // DOM ready
    document.addEventListener("DOMContentLoaded", () => {
      // Mobile menu toggle (if you actually have a mobile menu)
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');
      if (mobileMenuToggle && mobileMenu) {
        mobileMenuToggle.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        mobileMenu.addEventListener('click', (e) => {
          if (e.target.tagName === 'A') mobileMenu.classList.add('hidden');
        });
      }
      // Smooth scrolling for internal anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const targetId = this.getAttribute('href');
          const targetElement = document.querySelector(targetId);
          if (targetElement) {
            window.scrollTo({
              top: targetElement.offsetTop - 100,
              behavior: 'smooth'
            });
          }
        });
      });
      // Navbar background change on scroll (if navbar exists)
      const navbar = document.getElementById('navbar');
      if (navbar) {
        window.addEventListener('scroll', () => {
          try {
            const glass = navbar.querySelector('.glass');
            if (!glass) return;
            if (window.scrollY > 100) {
              glass.style.background = 'rgba(255, 255, 255, 0.95)';
            } else {
              glass.style.background = 'rgba(255, 255, 255, 0.85)';
            }
          } catch (e) { /* ignore */ }
        });
      }
      // Fade-in observer (if you use .fade-in elements)
      const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
          if (entry.isIntersecting) entry.target.classList.add("visible");
        });
      });
      document.querySelectorAll(".fade-in").forEach(el => observer.observe(el));
      // Chatbot logic
      const sendBtn = document.getElementById("sendBtn");
      const inputEl = document.getElementById("userInput");
      const chatBox = document.getElementById("chatBox");
      if (!sendBtn || !inputEl || !chatBox) {
        console.error("Chat UI elements missing (sendBtn, userInput or chatBox).");
        return;
      }
      // Helper to append bubbles -- keeping the style your friend used
      function appendUserMessage(text) {
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        chatBox.innerHTML += `<div class='chat-bubble bg-green-100 text-green-800 self-end float-right'><b>You:</b> ${escapeHtml(text)} <span class="timestamp">${timestamp}</span></div><div class='clear-both'></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      function appendAIMessage(text) {
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const renderedText = marked.parse(text); // Render Markdown to HTML
        chatBox.innerHTML += `<div class='chat-bubble bg-gray-100 text-gray-800 float-left'><b>Manoveda:</b> ${renderedText} <span class="timestamp">${timestamp}</span></div><div class='clear-both'></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      }
      // Basic HTML escaping to prevent injection
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      // Main send function
      async function sendMessage() {
        const userMsg = inputEl.value.trim();
        if (!userMsg) return;
        // Add user message immediately
        appendUserMessage(userMsg);
        inputEl.value = "";
        // Add typing indicator
        const typingId = "typing-indicator";
        chatBox.innerHTML += `<div id="${typingId}" class="chat-bubble typing">Manoveda is typing...</div><div class='clear-both'></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        try {
         const response = await fetch("https://vxknarwomlejxksmjinx.supabase.co/functions/v1/manoveda-ai", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4a25hcndvbWxlanhrc21qaW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTAzMjcsImV4cCI6MjA4NTgyNjMyN30.EG9iRbnR98roL18qEL6zmJLKbbROc0mSPmNh1MZnBZ4"
            },
            body: JSON.stringify({ userMsg })
          });
          // Remove typing indicator (if still present)
          const typingEl = document.getElementById(typingId);
          if (typingEl) typingEl.remove();
          // Parse and handle response
          const data = await response.json();
          if (!response.ok) {
            console.error("Backend error:", data);
            appendAIMessage("Server error. Check your backend (401 means token missing).");
            return;
          }
          const reply = data?.reply || "Sorry, I couldn’t answer that.";
          appendAIMessage(reply);
        } catch (err) {
          // Remove typing indicator (if still present)
          const typingEl = document.getElementById(typingId);
          if (typingEl) typingEl.remove();
          console.error("Network error:", err);
          chatBox.innerHTML += `<div class='text-red-500 mt-2'>⚠️ Error: ${escapeHtml(err.message || String(err))}</div>`;
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }
      // Button + Enter key binding
      sendBtn.addEventListener("click", sendMessage);
      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>


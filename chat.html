<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ManoVeda — Chat</title>

  <!-- Use your external chat.css (keep your file as provided) -->
  <link rel="stylesheet" href="chat.css" />

  <!-- Fonts / icons already used in your project -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Markdown parser and sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

  <!-- Small additions to complement your chat.css for readable paragraphs & code -->
  <style>
    /* make sure rendered markdown inside bot bubbles looks good */
    .bot-message p { margin: 0 0 0.75rem; }
    .bot-message ul, .bot-message ol { margin: 0.4rem 0 0.8rem 1.1rem; }
    .bot-message code { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; font-family: monospace; }
    .message time { display:block; font-size: 11px; opacity: 0.6; margin-top: 6px; }
    /* ensure chat box has comfortable bottom padding so last message not hidden under input */
    .chat-box { padding-bottom: 24px; }
    /* typing bubble small animation tweak */
    .bot-message.typing { opacity: 0.9; }
    .typing-dots span { display:inline-block; width:6px; height:6px; margin-left:4px; border-radius:50%; background:#fff; opacity:.25; animation: blink 1s infinite; }
    .typing-dots span:nth-child(2){ animation-delay: .15s }
    .typing-dots span:nth-child(3){ animation-delay: .30s }
    @keyframes blink { 0%{opacity:.2}50%{opacity:1}100%{opacity:.2} }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- optional luxury frame if you use it in markup -->
    <div class="luxury-frame" aria-hidden="true">
      <div class="lux-seg lux-top"></div>
      <div class="lux-seg lux-right"></div>
      <div class="lux-seg lux-bottom"></div>
      <div class="lux-seg lux-left"></div>
    </div>

    <!-- Top Navigation -->
    <nav id="navbar">
      <div class="glass">
        <div class="brand"><span class="mano">Mano</span><span class="veda">Veda AI</span></div>
        <a class="back" href="Index.html">← Dashboard</a>
      </div>
    </nav>

    <!-- Chat Messages -->
    <div class="chat-box" id="chatBox" role="log" aria-live="polite"></div>

    <!-- Input Area -->
    <div class="chat-input-area" role="form">
      <input type="text" id="userInput" placeholder="Type your thoughts here..." autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
(function () {
  /* =========================
     CONFIG
  ========================= */
  const SUPABASE_URL = "https://vxknarwomlejxksmjinx.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4a25hcndvbWxlanhrc21qaW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNTAzMjcsImV4cCI6MjA4NTgyNjMyN30.EG9iRbnR98roL18qEL6zmJLKbbROc0mSPmNh1MZnBZ4";

  const FUNCTION_URL =
    "https://vxknarwomlejxksmjinx.supabase.co/functions/v1/manoveda-ai";

  /* =========================
     LOAD SUPABASE (UMD)
  ========================= */
  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  /* =========================
     SESSION ID (CRITICAL)
  ========================= */
  let sessionId = localStorage.getItem("manoveda_chat_session");
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem("manoveda_chat_session", sessionId);
  }

  /* =========================
     DOM
  ========================= */
  const chatBox = document.getElementById("chatBox");
  const inputEl = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");

  /* =========================
     UI HELPERS
  ========================= */
  function createMessageEl({ role, htmlContent, textContent }) {
    const wrapper = document.createElement("div");
    wrapper.className =
      "message " + (role === "user" ? "user-message" : "bot-message");

    const content = document.createElement("div");
    content.className = "message-content";

    if (role === "user") {
      content.textContent = textContent;
    } else {
      content.innerHTML = htmlContent;
    }

    wrapper.appendChild(content);

    const timeEl = document.createElement("time");
    timeEl.textContent = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
    wrapper.appendChild(timeEl);

    return wrapper;
  }

  function appendUserMessage(text) {
    chatBox.appendChild(
      createMessageEl({ role: "user", textContent: text })
    );
    scrollToBottom();
  }

  function appendAIMessage(markdown) {
    const rawHtml = marked.parse(String(markdown));
    const safe = DOMPurify.sanitize(rawHtml, {
      ALLOWED_ATTR: ["href", "target", "rel"],
    });
    chatBox.appendChild(
      createMessageEl({ role: "bot", htmlContent: safe })
    );
    scrollToBottom();
  }

  function scrollToBottom() {
    chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
  }

  function setSending(sending) {
    sendBtn.disabled = sending;
    sendBtn.style.opacity = sending ? 0.7 : 1;
  }

  /* =========================
     SUPABASE INSERT (FIX)
  ========================= */
  async function storeMessage(role, message) {
    try {
      await supabase.from("chat_messages").insert({
        session_id: sessionId,
        role: role,              // 'user' | 'assistant'
        message: message
      });
    } catch (e) {
      console.error("Supabase insert failed", e);
    }
  }

  /* =========================
     SEND MESSAGE
  ========================= */
  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    appendUserMessage(text);
    inputEl.value = "";
    setSending(true);

    // ✅ store USER message
    storeMessage("user", text);

    try {
      const res = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({ userMsg: text }),
      });

      let data;
      try {
        data = await res.json();
      } catch {
        throw new Error("Invalid JSON from server");
      }

      const reply =
        data?.reply || data?.message || "Sorry, I couldn't answer that.";

      appendAIMessage(reply);

      // ✅ store ASSISTANT message
      storeMessage("assistant", reply);

    } catch (err) {
      appendAIMessage(`⚠️ ${err.message}`);
    } finally {
      setSending(false);
    }
  }

  /* =========================
     EVENTS
  ========================= */
  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  /* =========================
     WELCOME (UI ONLY)
  ========================= */
  appendAIMessage(
    "Hello — I'm **ManoVeda**, here to listen and support you. Type anything whenever you're ready."
  );

})();
</script>

</body>
</html>

